<%- include('../partials/header', { title: 'My Registrations', user: user }) %>

<div class="page-header">
  <div class="container">
    <h1><i class="bi bi-calendar-check-fill"></i> My Event Registrations</h1>
    <p>View all events you are registered for</p>
  </div>
</div>

<div class="container">
  <div class="card">
    <% if (registrations.length === 0) { %>
    <div class="text-center py-5">
      <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d"></i>
      <h3 class="mt-3">No Registrations Yet</h3>
      <p class="text-muted">You haven't registered for any events.</p>
      <a href="/events" class="btn btn-primary">Browse Events</a>
    </div>
    <% } else { %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Event Name</th>
            <th>Type</th>
            <th>Date & Time</th>
            <th>Location</th>
            <th>Status</th>
            <th>Check-in Time</th>
            <th>Registration Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% registrations.forEach(r => { %>
          <tr>
            <td>
              <strong><%= r.eventname || '—' %></strong>
              <% if (r.eventdescription) { %>
              <br /><small class="text-muted"
                ><%= r.eventdescription.substring(0, 60) %><%=
                r.eventdescription.length > 60 ? '...' : '' %></small
              >
              <% } %>
            </td>
            <td>
              <% if (r.eventtype) { %>
              <span class="badge bg-secondary"><%= r.eventtype %></span>
              <% } else { %> — <% } %>
            </td>
            <td>
              <% if (r.eventdatetimestart) { %> <%= new
              Date(r.eventdatetimestart).toLocaleString('en-US', { year:
              'numeric', month: 'short', day: 'numeric', hour: '2-digit',
              minute: '2-digit' }) %> <% if (r.eventdatetimeend) { %>
              <br /><small class="text-muted"
                >to <%= new Date(r.eventdatetimeend).toLocaleTimeString('en-US',
                { hour: '2-digit', minute: '2-digit' }) %></small
              >
              <% } %> <% } else { %> — <% } %>
            </td>
            <td><%= r.eventlocation || '—' %></td>
            <td>
              <% if (r.registrationstatus) { %> <% let badgeClass =
              'bg-secondary'; if (r.registrationstatus.toLowerCase() ===
              'confirmed') badgeClass = 'bg-success'; else if
              (r.registrationstatus.toLowerCase() === 'pending') badgeClass =
              'bg-warning'; else if (r.registrationstatus.toLowerCase() ===
              'cancelled') badgeClass = 'bg-danger'; %>
              <span class="badge <%= badgeClass %>"
                ><%= r.registrationstatus %></span
              >
              <% } else { %> — <% } %>
            </td>
            <td>
              <% if (r.registrationcheckintime) { %> <%= new
              Date(r.registrationcheckintime).toLocaleString('en-US', { year:
              'numeric', month: 'short', day: 'numeric', hour: '2-digit',
              minute: '2-digit' }) %> <% } else { %> — <% } %>
            </td>
            <td>
              <% if (r.registrationcreatedat) { %> <%= new
              Date(r.registrationcreatedat).toLocaleDateString('en-US', { year:
              'numeric', month: 'short', day: 'numeric' }) %> <% } else { %> —
              <% } %>
            </td>
            <td>
              <% // Check if user can submit a survey: 1. Has attended flag =1,
              // 2. Event is in the past, 3. No survey submitted yet const
              hasAttended = r.registrationattendedflag == 1; const eventEnded =
              r.eventdatetimeend && new Date(r.eventdatetimeend) < new Date();
              const noSurvey = !r.surveyid; const canSubmitSurvey = hasAttended
              && eventEnded && noSurvey; %> <% if (canSubmitSurvey) { %>
              <a
                href="/registrations/<%= r.registrationid %>/survey"
                class="btn btn-sm btn-primary"
              >
                <i class="bi bi-clipboard-check"></i> Submit Survey
              </a>
              <% } else if (r.surveyid) { %>
              <span class="badge bg-success"
                ><i class="bi bi-check-circle-fill"></i> Survey Completed</span
              >
              <% } else { %> — <% } %>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>
  </div>
</div>

<%- include('../partials/footer-scripts') %>
