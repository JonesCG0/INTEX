<%- include('../partials/header', { title: 'Add Milestone', user: user }) %>

<div class="page-header">
  <div class="container">
    <h1><i class="bi bi-flag-fill"></i> Add New Milestone</h1>
    <p>Create a new achievement milestone</p>
  </div>
</div>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card">
        <% if (error) { %>
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill"></i> <%= error %>
        </div>
        <% } %>

        <form action="/milestones/new" method="POST">
          <div class="mb-3">
            <label for="milestonetitle" class="form-label"
              >Milestone Title</label
            >
            <input
              type="text"
              id="milestonetitle"
              name="milestonetitle"
              class="form-control"
              placeholder="Enter milestone title"
            />
          </div>

          <div class="mb-3">
            <label for="milestonedate" class="form-label">Milestone Date</label>
            <input
              type="date"
              id="milestonedate"
              name="milestonedate"
              class="form-control"
            />
          </div>

          <div class="mb-3">
            <label for="participantSearch" class="form-label">Participant</label>
            <input
              type="text"
              id="participantSearch"
              class="form-control"
              placeholder="Search by name, email, or ID..."
              list="participantList"
              autocomplete="off"
            />
            <datalist id="participantList">
              <% users.forEach(u => { %>
                <option
                  value="ID: <%= u.userid %> - <%= u.userfirstname %> <%= u.userlastname %>"
                  data-userid="<%= u.userid %>"
                  data-first-name="<%= u.userfirstname %>"
                  data-last-name="<%= u.userlastname %>"
                >
                  <%= u.useremail %>
                </option>
              <% }); %>
            </datalist>
            <input type="hidden" id="userid" name="userid" required />
            <small class="form-text text-muted">Start typing to search by name, email, or ID</small>
          </div>

          <div class="d-grid gap-2 d-md-flex">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-check-circle-fill"></i> Create Milestone
            </button>
            <a href="/milestones" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i> Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Handle participant selection
  const participantSearch = document.getElementById('participantSearch');
  const useridInput = document.getElementById('userid');
  const participantList = document.getElementById('participantList');

  const participantOptions = participantList
    ? Array.from(participantList.querySelectorAll('option')).map(option => {
        const firstName = option.dataset.firstName || '';
        const lastName = option.dataset.lastName || '';
        return {
          value: option.value,
          userId: Number(option.dataset.userid),
          firstName,
          lastName,
          sortFirst: firstName.toLowerCase(),
          sortLast: lastName.toLowerCase(),
          emailText: option.textContent
        };
      })
    : [];

  const alphabeticalSort = (a, b) => {
    const firstCmp = a.sortFirst.localeCompare(b.sortFirst);
    if (firstCmp !== 0) return firstCmp;
    const lastCmp = a.sortLast.localeCompare(b.sortLast);
    if (lastCmp !== 0) return lastCmp;
    return a.userId - b.userId;
  };

  const numericSort = (a, b) => a.userId - b.userId;

  const renderParticipantOptions = (data) => {
    if (!participantList) return;
    participantList.innerHTML = '';
    data.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt.value;
      option.dataset.userid = opt.userId;
      option.dataset.firstName = opt.firstName;
      option.dataset.lastName = opt.lastName;
      option.textContent = opt.emailText;
      participantList.appendChild(option);
    });
  };

  const updateParticipantSort = (term) => {
    if (!participantOptions.length) return;
    const trimmed = term.trim();
    const useNumeric = trimmed !== '' && /^[0-9]+$/.test(trimmed);
    const sorted = participantOptions.slice().sort(useNumeric ? numericSort : alphabeticalSort);
    renderParticipantOptions(sorted);
  };

  participantSearch.addEventListener('input', function() {
    updateParticipantSort(this.value);
    const selectedValue = this.value;

    // Extract user ID from the format "ID: 123 - FirstName LastName"
    const match = selectedValue.match(/^ID:\s*(\d+)\s*-/);

    if (match) {
      useridInput.value = match[1];
    } else {
      useridInput.value = '';
    }
  });

  updateParticipantSort('');

  // Validate that a user is selected before submitting
  const form = participantSearch.closest('form');
  form.addEventListener('submit', function(e) {
    if (!useridInput.value) {
      e.preventDefault();
      alert('Please select a valid participant from the list.');
    }
  });
</script>

<%- include('../partials/footer-scripts') %>
